name: Argus AI CI

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"

defaults:
  run:
    shell: bash

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: pyproject.toml

      - name: Install lint deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff

      - name: Ruff lint
        run: ruff check app/ tests/

      - name: Ruff format
        run: ruff format --check app/ tests/

  test:
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: argus_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test -d argus_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: pyproject.toml

      - name: Wait for PostgreSQL
        run: |
          for i in $(seq 1 60); do
            if docker exec "${{ job.services.postgres.id }}" pg_isready -U test -d argus_test; then
              exit 0
            fi
            sleep 1
          done
          echo "PostgreSQL não ficou saudável a tempo"
          docker logs "${{ job.services.postgres.id }}" || true
          exit 1

      - name: Ensure pgvector extension files
        run: |
          docker exec --user root "${{ job.services.postgres.id }}" bash -euxo pipefail -c '
            if [ -f /usr/share/postgresql/16/extension/vector.control ]; then
              echo "pgvector já está disponível"
              exit 0
            fi

            apt-get update
            if apt-cache show postgresql-16-pgvector >/dev/null 2>&1; then
              apt-get install -y --no-install-recommends postgresql-16-pgvector
              exit 0
            fi

            apt-get install -y --no-install-recommends \
              ca-certificates \
              git \
              build-essential \
              postgresql-server-dev-16
            git clone --branch v0.8.1 --depth 1 https://github.com/pgvector/pgvector.git /tmp/pgvector
            cd /tmp/pgvector
            make
            make install
          '

      - name: Setup PostgreSQL extensions
        run: |
          docker exec -e PGPASSWORD=test ${{ job.services.postgres.id }} \
            psql -v ON_ERROR_STOP=1 -U test -d argus_test -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
          docker exec -e PGPASSWORD=test ${{ job.services.postgres.id }} \
            psql -v ON_ERROR_STOP=1 -U test -d argus_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"
          docker exec -e PGPASSWORD=test ${{ job.services.postgres.id }} \
            psql -v ON_ERROR_STOP=1 -U test -d argus_test -c "CREATE EXTENSION IF NOT EXISTS vector;"
          docker exec -e PGPASSWORD=test ${{ job.services.postgres.id }} \
            psql -v ON_ERROR_STOP=1 -U test -d argus_test -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"
          docker exec -e PGPASSWORD=test ${{ job.services.postgres.id }} \
            psql -v ON_ERROR_STOP=1 -U test -d argus_test -c "CREATE EXTENSION IF NOT EXISTS unaccent;"

      - name: Start MinIO
        run: |
          docker run -d -p 9000:9000 --name minio \
            -e MINIO_ROOT_USER=test \
            -e MINIO_ROOT_PASSWORD=test \
            minio/minio:latest server /data

      - name: Wait for MinIO health
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://localhost:9000/minio/health/live >/dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "MinIO não ficou saudável a tempo"
          docker logs minio || true
          exit 1

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -e ".[dev]"

      - name: Initialize test artifact files
        run: |
          : > pytest.log
          : > coverage.xml

      - name: Run tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/argus_test
          REDIS_URL: redis://localhost:6379
          SECRET_KEY: test-secret-key-ci-32bytes-long!!
          ENCRYPTION_KEY: YLPrjiTU1zUbkNkp4Mwq7XZlj0ysJIDnfUdGnSHULDg=
          S3_ENDPOINT: http://localhost:9000
          S3_ACCESS_KEY: test
          S3_SECRET_KEY: test
          S3_BUCKET: argus-test
        run: |
          # Create S3 bucket
          python -c "import os, boto3; s3 = boto3.client('s3', endpoint_url=os.environ['S3_ENDPOINT'], aws_access_key_id=os.environ['S3_ACCESS_KEY'], aws_secret_access_key=os.environ['S3_SECRET_KEY']); s3.create_bucket(Bucket=os.environ['S3_BUCKET'])"

          pytest --maxfail=5 --disable-warnings -q --cov=app --cov-report=xml 2>&1 | tee pytest.log
          test ${PIPESTATUS[0]} -eq 0

      - name: Collect service logs on failure
        if: failure()
        run: |
          echo "=== PostgreSQL logs ===" > ci-debug.log
          docker logs "${{ job.services.postgres.id }}" >> ci-debug.log 2>&1 || true
          echo "" >> ci-debug.log
          echo "=== Redis logs ===" >> ci-debug.log
          docker logs "${{ job.services.redis.id }}" >> ci-debug.log 2>&1 || true
          echo "" >> ci-debug.log
          echo "=== MinIO logs ===" >> ci-debug.log
          docker logs minio >> ci-debug.log 2>&1 || true

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            pytest.log
            coverage.xml
            ci-debug.log
          if-no-files-found: warn
          retention-days: 30
